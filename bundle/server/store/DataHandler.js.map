{"version":3,"sources":["../../../server/store/DataHandler.js"],"names":["datahandler_singleton_promise","datahandler_singleton","DataHandler","_get","then","dh","Promise","resolve","constant","REDISCLOUD_URL","init","storeType","datastoreType","datastore","botConfig","botAllDataUserResponse","paths","access_token","bot_config","question_flow","user_progress","user_response","LocalFileDataStore","Object","keys","reduce","acc","key","LOCAL_FILE_STORE_PATH","RedisDataStore","BotConfig","all","load","QuestionFlow","userID","UserResponse","_scan","UserProgress","AccessToken"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AAEA,IAAIA,gCAAgC,IAApC;AACA,IAAIC,wBAAwB,IAA5B;;IAEqBC,W;;;0BAEN;AACX,UAAIF,6BAAJ,EAAmC;AACjC,eAAOA,6BAAP;AACD;AACD,UAAI,CAACC,qBAAL,EAA4B;AAC1BD,wCACEE,YAAYC,IAAZ,GACGC,IADH,CACQ,UAACC,EAAD,EAAQ;AACZJ,kCAAwBI,EAAxB;AACAL,0CAAgC,IAAhC;AACA,iBAAOK,EAAP;AACD,SALH,CADF;AAOA,eAAOL,6BAAP;AACD;AACD,aAAOM,QAAQC,OAAR,CAAgBN,qBAAhB,CAAP;AACD;;;2BAEa;AACZ,UAAIO,mBAASC,cAAT,IAA2B,EAA/B,EAAmC;AACjC,eAAQ,IAAIP,WAAJ,CAAgB,OAAhB,CAAD,CAA2BQ,IAA3B,EAAP;AACD,OAFD,MAEO;AACL,eAAQ,IAAIR,WAAJ,CAAgB,OAAhB,CAAD,CAA2BQ,IAA3B,EAAP;AACD;AACF;;;AAED,uBAAYC,SAAZ,EAAuB;AAAA;;AACrB,SAAKC,aAAL,GAAqBD,SAArB;AACA,SAAKE,SAAL,GAAiB,IAAjB;AACA,SAAKC,SAAL,GAAiB,IAAjB;AACA,SAAKC,sBAAL,GAA8B,IAA9B;AACD;;;;2BAEM;AAAA;;AACL,UAAIC,QAAQ;AACVC,sBAAc,cADJ;AAEVC,oBAAY,YAFF;AAGVC,uBAAe,eAHL;AAIVC,uBAAe,cAJL;AAKVC,uBAAe;AALL,OAAZ;;AAQA,cAAQ,KAAKT,aAAb;AACE,aAAK,OAAL;AACE,eAAKC,SAAL,GAAiB,IAAIS,4BAAJ,EAAjB;AACA,eAAKT,SAAL,CAAeG,KAAf,GAAuBO,OAAOC,IAAP,CAAYR,KAAZ,EAAmBS,MAAnB,CAA0B,UAACC,GAAD,EAAMC,GAAN,EAAc;AAC7DD,gBAAIC,GAAJ,IAAcnB,mBAASoB,qBAAvB,SAAgDZ,MAAMW,GAAN,CAAhD;AACA,mBAAOD,GAAP;AACD,WAHsB,EAGpB,EAHoB,CAAvB;AAIA;AACF,aAAK,OAAL;AACE,eAAKb,SAAL,GAAiB,IAAIgB,wBAAJ,EAAjB;AACA,eAAKhB,SAAL,CAAeG,KAAf,GAAuBA,KAAvB;AACA;AAXJ;;AAcA,WAAKF,SAAL,GAAiB,IAAIgB,gBAAJ,CAAc,IAAd,CAAjB;;AAEA,aAAOxB,QAAQyB,GAAR,CAAY,CACjB,KAAKjB,SAAL,CAAekB,IAAf,EADiB,CAAZ,EAGN5B,IAHM,CAGD,YAAM;AACV,eAAO,KAAP;AACD,OALM,CAAP;AAMD;;;oCAEeuB,G,EAAK;AACnB,aAAQ,IAAIM,sBAAJ,CAAiB,IAAjB,CAAD,CAAyBD,IAAzB,CAA8BL,GAA9B,CAAP;AACD;;;oCAEeO,M,EAAQ;AACtB,aAAQ,IAAIC,sBAAJ,CAAiB,IAAjB,CAAD,CAAyBH,IAAzB,CAA8BE,MAA9B,CAAP;AACD;;;wCAEmB;AAClB,aAAO,KAAKrB,SAAL,CAAeuB,KAAf,CAAqB,KAAKvB,SAAL,CAAeG,KAAf,CAAqBK,aAA1C,CAAP;AACD;;;oCAEea,M,EAAQ;AACtB,aAAQ,IAAIG,sBAAJ,CAAiB,IAAjB,CAAD,CAAyBL,IAAzB,CAA8BE,MAA9B,CAAP;AACD;;;qCAEgB;AACf,aAAQ,IAAII,qBAAJ,CAAgB,IAAhB,CAAD,CAAwBN,IAAxB,EAAP;AACD;;;;;;kBArFkB9B,W","file":"DataHandler.js","sourcesContent":["import AccessToken from 'server/store/accesstoken/accessToken';\nimport BotConfig from 'server/store/bot/config';\nimport constant from 'common/constant';\nimport LocalFileDataStore from 'server/store/datastore/LocalFileDatastore';\nimport QuestionFlow from 'server/store/question/questionFlow';\nimport RedisDataStore from 'server/store/datastore/RedisDatastore';\nimport UserProgress from 'server/store/user/userProgress';\nimport UserResponse from 'server/store/user/userResponse';\n\nlet datahandler_singleton_promise = null;\nlet datahandler_singleton = null;\n\nexport default class DataHandler {\n\n  static get() {\n    if (datahandler_singleton_promise) {\n      return datahandler_singleton_promise;\n    }\n    if (!datahandler_singleton) {\n      datahandler_singleton_promise = \n        DataHandler._get()\n          .then((dh) => {\n            datahandler_singleton = dh;\n            datahandler_singleton_promise = null;\n            return dh;\n          });\n      return datahandler_singleton_promise;\n    }\n    return Promise.resolve(datahandler_singleton);\n  }\n\n  static _get() {\n    if (constant.REDISCLOUD_URL == '') {\n      return (new DataHandler('local')).init();\n    } else {\n      return (new DataHandler('redis')).init();\n    }\n  }\n\n  constructor(storeType) {\n    this.datastoreType = storeType;\n    this.datastore = null;\n    this.botConfig = null;\n    this.botAllDataUserResponse = null;\n  }\n\n  init() {\n    let paths = {\n      access_token: 'access_token',\n      bot_config: 'bot_config',\n      question_flow: 'question_flow',\n      user_progress: 'user_progres', \n      user_response: 'user_response',\n    };\n\n    switch (this.datastoreType) {\n      case 'local':\n        this.datastore = new LocalFileDataStore();\n        this.datastore.paths = Object.keys(paths).reduce((acc, key) => {\n          acc[key] = `${constant.LOCAL_FILE_STORE_PATH}/${paths[key]}`;\n          return acc;\n        }, {});\n        break;\n      case 'redis':\n        this.datastore = new RedisDataStore();\n        this.datastore.paths = paths;\n        break;\n    }\n\n    this.botConfig = new BotConfig(this);\n\n    return Promise.all([\n      this.botConfig.load(),\n    ])\n    .then(() => {\n      return this;\n    });\n  }\n\n  getQuestionFlow(key) {\n    return (new QuestionFlow(this)).load(key);\n  }\n\n  getUserResponse(userID) {\n    return (new UserResponse(this)).load(userID);\n  }\n\n  scanUserResponses() {\n    return this.datastore._scan(this.datastore.paths.user_response);\n  }\n\n  getUserProgress(userID) {\n    return (new UserProgress(this)).load(userID);\n  }\n\n  getAccessToken() {\n    return (new AccessToken(this)).load();\n  }\n\n}\n"]}