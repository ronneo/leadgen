{"version":3,"sources":["../../../server/authEndpoint/lead.js"],"names":["init","genCSVBuilder","dh","flatattr","getQuestionFlow","then","question_flow","header","questions","forEach","question","index","needNoAnswer","questionHandlerMap","type","push","key","user_resps","row","Array","length","map","resp","indexOf","qid","payload","timeOfMessage","loadOneUserResponse","csv_builder","getUserResponse","user_resp_mgr","userResponses","loadAllResponsesForExport","scanUserResponses","keys","Promise","resolve","_reject","_load","callback","rest_keys","splice","app","get","req","res","csv","catch","err","logger","error","JSON","stringify","sendStatus","fbtrEvents","LEADGENBOT_EXPORT_LEAD","status","send","all","query","getUserProgress","user_prog_mgr","progress","userProgress","response","delete","del","user_progress_mgr"],"mappings":";;;;;;;;QAgEgBA,I,GAAAA,I;;AAhEhB;;;;AAEA;;AACA;;;;AAEA,SAASC,aAAT,CAAuBC,EAAvB,EAA2BC,QAA3B,EAAqC;AACnC,SAAOD,GAAGE,eAAH,GACJC,IADI,CACC,UAACC,aAAD,EAAmB;AACvB,QAAIC,SAAS,CAAC,KAAD,CAAb;AACAD,kBAAcE,SAAd,CAAwBC,OAAxB,CAAgC,UAACC,QAAD,EAAWC,KAAX,EAAqB;AACnD,UAAIC,eAAeC,qCAAmBH,SAASI,IAA5B,EAAkC,CAAlC,EAAqCJ,QAArC,EAA+C,EAA/C,EAAmD,CAAnD,CAAnB;AACA,UAAI,CAACE,YAAL,EAAmB;AACjBL,eAAOQ,IAAP,OAAgBJ,KAAhB;AACAJ,eAAOQ,IAAP,aAAsBJ,KAAtB;AACAJ,eAAOQ,IAAP,mBAA4BJ,KAA5B;AACD;AACF,KAPD;AAQAR,aAASY,IAAT,CAAcR,MAAd;AACA,WAAOA,MAAP;AACD,GAbI,EAcJF,IAdI,CAcC,UAACE,MAAD,EAAY;AAChB,WAAO,UAACS,GAAD,EAAMC,UAAN,EAAqB;AAC1B,UAAIC,MAAO,IAAIC,KAAJ,CAAUZ,OAAOa,MAAjB,CAAD,CAA2BC,GAA3B,CAA+B,YAAM;AAAE,eAAO,EAAP;AAAY,OAAnD,CAAV;AACAH,UAAI,CAAJ,IAASF,GAAT;AACAC,iBAAWR,OAAX,CAAmB,UAACa,IAAD,EAAU;AAC3B,YAAIX,QAAQJ,OAAOgB,OAAP,OAAmBD,KAAKE,GAAxB,CAAZ;AACAN,YAAIP,KAAJ,IAAaW,KAAKE,GAAlB;AACAN,YAAIP,QAAM,CAAV,IAAeW,KAAKG,OAApB;AACAP,YAAIP,QAAM,CAAV,IAAeW,KAAKI,aAApB;AACD,OALD;AAMAvB,eAASY,IAAT,CAAcG,GAAd;AACD,KAVD;AAWD,GA1BI,CAAP;AA2BD;;AAED,SAASS,mBAAT,CAA6BzB,EAA7B,EAAiCc,GAAjC,EAAsCY,WAAtC,EAAmD;AACjD,SAAO1B,GAAG2B,eAAH,CAAmBb,GAAnB,EACJX,IADI,CACC,UAACyB,aAAD,EAAmB;AACvBF,gBAAYZ,GAAZ,EAAiBc,cAAcC,aAA/B;AACA,WAAOf,GAAP;AACD,GAJI,CAAP;AAKD;;AAED,SAASgB,yBAAT,CAAmC9B,EAAnC,EAAuC0B,WAAvC,EAAoD;AAClD,SAAO1B,GAAG+B,iBAAH,GACJ5B,IADI,CACC,UAAC6B,IAAD,EAAU;AACd,WAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,OAAV,EAAsB;AACvC,eAASC,KAAT,CAAeJ,IAAf,EAAqBK,QAArB,EAA+B;AAC7B,YAAIL,KAAKd,MAAL,IAAe,CAAnB,EAAsB;AACpBmB;AACD,SAFD,MAEO;AACL,cAAIvB,MAAMkB,KAAK,CAAL,CAAV;AACA,cAAIM,YAAYN,KAAKO,MAAL,CAAY,CAAZ,CAAhB;AACAd,8BAAoBzB,EAApB,EAAwBc,GAAxB,EAA6BY,WAA7B,EACGvB,IADH,CACQ,YAAM;AACViC,kBAAME,SAAN,EAAiBD,QAAjB;AACD,WAHH;AAID;AACF;AACDD,YAAMJ,IAAN,EAAYE,OAAZ;AACD,KAdM,CAAP;AAeD,GAjBI,CAAP;AAkBD;;AAEM,SAASpC,IAAT,CAAc0C,GAAd,EAAmBxC,EAAnB,EAAuB;AAC5BwC,MAAIC,GAAJ,CAAQ,iBAAR,EAA2B,UAACC,GAAD,EAAMC,GAAN,EAAc;AACvC,QAAI1C,WAAW,EAAf;AACAF,kBAAcC,EAAd,EAAkBC,QAAlB,EACGE,IADH,CACQ,UAACuB,WAAD,EAAiB;AACrB,aAAOI,0BAA0B9B,EAA1B,EAA8B0B,WAA9B,CAAP;AACD,KAHH,EAIGvB,IAJH,CAIQ,YAAM;AACVwC,UAAIC,GAAJ,CAAQ3C,QAAR;AACD,KANH,EAOG4C,KAPH,CAOS,UAACC,GAAD,EAAS;AACdC,uBAAOC,KAAP,wDAAkEC,KAAKC,SAAL,CAAeJ,GAAf,CAAlE;AACAH,UAAIQ,UAAJ,CAAe,GAAf;AACD,KAVH;AAWA,oBAAKC,iBAAWC,sBAAhB;AACD,GAdD;;AAgBAb,MAAIC,GAAJ,CAAQ,iBAAR,EAA2B,UAACC,GAAD,EAAMC,GAAN,EAAc;AACvC3C,OAAG+B,iBAAH,GACG5B,IADH,CACQ,UAAC6B,IAAD,EAAU;AACdW,UAAIW,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBvB,IAArB;AACD,KAHH;AAID,GALD;;AAOAQ,MAAIC,GAAJ,CAAQ,gBAAR,EAA0B,UAACC,GAAD,EAAMC,GAAN,EAAc;AACtCV,YAAQuB,GAAR,CAAY,CACVxD,GAAG2B,eAAH,CAAmBe,IAAIe,KAAJ,CAAU3C,GAA7B,CADU,EAEVd,GAAG0D,eAAH,CAAmBhB,IAAIe,KAAJ,CAAU3C,GAA7B,CAFU,CAAZ,EAICX,IAJD,CAIM,gBAAoC;AAAA;AAAA,UAAlCyB,aAAkC;AAAA,UAAnB+B,aAAmB;;AACxChB,UAAIW,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AACnBK,kBAAUD,cAAcE,YADL;AAEnBC,kBAAUlC,cAAcC;AAFL,OAArB;AAID,KATD;AAUD,GAXD;;AAaAW,MAAIuB,MAAJ,CAAW,gBAAX,EAA6B,UAACrB,GAAD,EAAMC,GAAN,EAAc;AACzC3C,OAAG2B,eAAH,CAAmBe,IAAIe,KAAJ,CAAU3C,GAA7B,EACGX,IADH,CACQ,UAACyB,aAAD,EAAmB;AACvB,aAAOA,cAAcoC,GAAd,EAAP;AACD,KAHH,EAIG7D,IAJH,CAIQ,YAAM;AACV,aAAOH,GAAG0D,eAAH,CAAmBhB,IAAIe,KAAJ,CAAU3C,GAA7B,CAAP;AACD,KANH,EAOGX,IAPH,CAOQ,UAAC8D,iBAAD,EAAuB;AAC3B,aAAOA,kBAAkBD,GAAlB,EAAP;AACD,KATH,EAUG7D,IAVH,CAUQ,YAAM;AACVwC,UAAIQ,UAAJ,CAAe,GAAf;AACD,KAZH;AAaD,GAdD;AAeD","file":"lead.js","sourcesContent":["import logger from 'common/logger';\n\nimport { questionHandlerMap } from 'server/handler/questionHandlers';\nimport { fbtrEvents, fbtr } from 'common/fbtr';\n\nfunction genCSVBuilder(dh, flatattr) {\n  return dh.getQuestionFlow()\n    .then((question_flow) => {\n      let header = ['uid'];\n      question_flow.questions.forEach((question, index) => {\n        let needNoAnswer = questionHandlerMap[question.type](0, question, {})[1];\n        if (!needNoAnswer) {\n          header.push(`q${index}`);\n          header.push(`payload${index}`);\n          header.push(`timeofmessage${index}`);\n        }\n      });\n      flatattr.push(header);\n      return header;\n    })\n    .then((header) => {\n      return (key, user_resps) => {\n        let row = (new Array(header.length)).map(() => { return ''; });\n        row[0] = key;\n        user_resps.forEach((resp) => {\n          let index = header.indexOf(`q${resp.qid}`);\n          row[index] = resp.qid;\n          row[index+1] = resp.payload;\n          row[index+2] = resp.timeOfMessage;\n        });\n        flatattr.push(row);\n      };\n    });\n}\n\nfunction loadOneUserResponse(dh, key, csv_builder) {\n  return dh.getUserResponse(key)\n    .then((user_resp_mgr) => {\n      csv_builder(key, user_resp_mgr.userResponses);\n      return key;\n    });\n}\n\nfunction loadAllResponsesForExport(dh, csv_builder) {\n  return dh.scanUserResponses()\n    .then((keys) => {\n      return new Promise((resolve, _reject) => {\n        function _load(keys, callback) {\n          if (keys.length <= 0) {\n            callback();\n          } else {\n            let key = keys[0];\n            let rest_keys = keys.splice(1);\n            loadOneUserResponse(dh, key, csv_builder)\n              .then(() => {\n                _load(rest_keys, callback);\n              });\n          }\n        }\n        _load(keys, resolve);\n      });\n    });\n}\n\nexport function init(app, dh) {\n  app.get('/download_leads', (req, res) => {\n    let flatattr = [];\n    genCSVBuilder(dh, flatattr)\n      .then((csv_builder) => {\n        return loadAllResponsesForExport(dh, csv_builder);\n      })\n      .then(() => {\n        res.csv(flatattr);\n      })\n      .catch((err) => {\n        logger.error(`error while generating flat responses for export: ${JSON.stringify(err)}`);\n        res.sendStatus(500);\n      });\n    fbtr(fbtrEvents.LEADGENBOT_EXPORT_LEAD);\n  });\n\n  app.get('/lead_scan_keys', (req, res) => {\n    dh.scanUserResponses()\n      .then((keys) => {\n        res.status(200).send(keys);\n      });\n  });\n\n  app.get('/lead_with_key', (req, res) => {\n    Promise.all([\n      dh.getUserResponse(req.query.key),\n      dh.getUserProgress(req.query.key),\n    ])\n    .then(([user_resp_mgr, user_prog_mgr]) => {\n      res.status(200).send({\n        progress: user_prog_mgr.userProgress,\n        response: user_resp_mgr.userResponses\n      });\n    });\n  });\n\n  app.delete('/lead_with_key', (req, res) => {\n    dh.getUserResponse(req.query.key)\n      .then((user_resp_mgr) => {\n        return user_resp_mgr.del();\n      })\n      .then(() => {\n        return dh.getUserProgress(req.query.key);\n      })\n      .then((user_progress_mgr) => {\n        return user_progress_mgr.del();\n      })\n      .then(() => {\n        res.sendStatus(200);\n      });\n  });\n}\n"]}